#!/usr/bin/tclsh8.4
# -*- Tcl -*- 
# usage: ./sg-run-builds <flight>

source osstestlib.tcl

readconfig

proc main {} {
    global flight jobinfo builds anyfailed argv

    set-flight
    become-task "$flight $argv"
    
    set builds {}

    db-open

    set to_run {}
    pg_execute -array jobinfo dbh "
        SELECT job, recipe FROM jobs
			WHERE	flight=$flight
			AND	job like 'build%'
			AND   ( status = 'queued'
			  OR	status = 'preparing'
			  OR	status = 'retriable' )
                        [specific-job-constraint]
		ORDER BY job
    " {
        lappend to_run [list $jobinfo(job) $jobinfo(recipe)]
    }

    foreach jobitem $to_run {
        lassign $jobitem jobinfo(job) jobinfo(recipe)
        perhaps-start-job
    }

    db-close

    set anyfailed 0
    foreach reap $builds {
	set job [lindex $reap 0]
        if {![reap-ts [lindex $reap 1] 1]} {
            set anyfailed 1
	    job-set-status $flight $job fail
	} else {
	    job-set-status $flight $job pass
        }
        db-close
    }

    if {$anyfailed} {
        logputs stderr "at least one build failed"
    }
}

proc perhaps-start-job {} {
    # db-{open,close} is done by main
    global jobinfo c builds flight doingarch

    setstatus preparing

    if {[catch {
        prepare-host
    } emsg]} {
        global errorInfo errorCode
        set ei $errorInfo
        set ec $errorCode
        run-ts broken * ts-logs-capture
        setstatus broken
        return
    }

    setstatus running
    lappend builds [list $jobinfo(job) [spawn-job/$jobinfo(recipe)]]
}

main
