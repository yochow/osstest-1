#!/usr/bin/tclsh8.4
# -*- Tcl -*- 
# usage: ./sg-run-builds <flight>

source osstestlib.tcl

readconfig

proc main {} {
    global flight jobinfo builds anyfailed argv

    set-flight

    set builds {}

    db-open

    foreach jobitem $to_run {
        lassign $jobitem jobinfo(job) jobinfo(recipe)
        perhaps-start-job
    }

    db-close

    set anyfailed 0
    foreach reap $builds {
	set job [lindex $reap 0]
        if {![reap-ts [lindex $reap 1] 1]} {
            set anyfailed 1
	    job-set-status $flight $job fail
	} else {
	    job-set-status $flight $job pass
        }
        db-close
    }

    if {$anyfailed} {
        logputs stderr "at least one build failed"
    }
}

proc perhaps-start-job {} {
    # db-{open,close} is done by main
    global jobinfo c builds flight doingarch

    setstatus preparing

    setstatus running
    lappend builds [list $jobinfo(job) [spawn-job/$jobinfo(recipe)]]
}

main
