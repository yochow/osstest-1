#

check_stop () {
	for stop_dir in '' $HOME/testing.git/; do
		if test -f $stop_dir${1}stop; then
			echo "$stop_dir${1}stop found - stopping"
			exit 0
		fi
	done
	if test -f ${1}xsettings; then
		echo "loading ${1}xsettings"
		. ${1}xsettings
	fi
}

check_stop ''

. cri-common

select_branch () {
	case "$branch" in
	xen*)		tree=xen;	xenbranch=$branch ;;
	linux)		tree=linux;	xenbranch=xen-unstable ;;
	linux-xen-*)	tree=linux;	xenbranch=xen-unstable ;;
	osstest)	tree=osstest;	xenbranch=xen-unstable ;;
	esac

	check_stop $branch.
	check_stop $xenbranch.any.

	mrof="$branch.mro"

	if test -f branch-settings.$branch; then
		. branch-settings.$branch
	fi
}

dcs=daily-cron-settings

if [ "x$1" = "x--real" ]; then
	: ${OSSTEST_BLESSING:=real}
	shift
elif [ "x$1" = "x--like-real" ]; then
	: ${OSSTEST_CRON_SETTINGS:=$dcs-real}
	: ${OSSTEST_HTML_SUFFIX:=-play}
	shift
fi	
: ${OSSTEST_BLESSING:=play}

: ${OSSTEST_EMAIL_HEADER:=daily-cron-email-$OSSTEST_BLESSING}

. ${OSSTEST_CRON_SETTINGS:-$dcs-$OSSTEST_BLESSING}

: ${OSSTEST_PUSH:=false}

: ${OSSTEST_HTML_DIR:=`getconfig PubBaseDir`/$OSSTEST_HTML_SUBDIR}
: ${OSSTEST_HTML_URL:=`getconfig PubBaseUrl`/$OSSTEST_HTML_SUBDIR}
: ${OSSTEST_HTMLPUB_DIR:=`getconfig Logs`}

execute_flight () {
        case "x$OSSTEST_SIMULATE" in
        x|x0)   ;;
        *)      echo SIMULATING - NOT EXECUTING $1 $2
                return
                ;;
        esac

        rm -f abort
        if test -f stop; then return; fi

        ./cr-ensure-disk-space

	export OSSTEST_RESOURCE_PREINFO="[$branch $2]"

        ./sg-execute-flight $1 $2 >tmp/$1.transcript 2>&1
        cat tmp/$1.transcript
}

send_email () {
        /usr/sbin/sendmail -odi -oee -oi -t <$1
        mv $1 $1.sent
}
