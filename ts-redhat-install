#!/usr/bin/perl -w
# This is part of "osstest", an automated testing framework for Xen.
# Copyright (C) 2009-2013 Citrix Inc.
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
# 
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

use strict qw(vars);
use DBI;
use Osstest;
use Osstest::TestSupport;

tsreadconfig();

our $stage=0;
if (@ARGV && $ARGV[0] =~ m/^--stage(\d+)$/) { $stage=$1; shift @ARGV; }

our ($whhost,$gn) = @ARGV;
$whhost ||= 'host';
$gn ||= 'redhat';

our $ho= selecthost($whhost);

our $ram_mb=    768;
our $disk_mb= 50000;

our $guesthost= "$gn.guest.osstest";
our $gho;

our $xl= toolstack()->{Command};


sub kickstart () {
    my $cryptpw= '$6$anjRJmBbJcrNJGWN$rqvGUhu8ITjvErdIA5C//w2R6b/6wAjHbaF7XF8u3lZg1XI3StthPIE6UII08scOFwASMOepCGpgtsYeCpjqb.';
    my $authkeys= authorized_keys();

    return <<"END";
# Kickstart file automatically generated by anaconda.
# edited by iwj

#version=RHEL6
install
cdrom
lang en_US.UTF-8
network --device eth0 --bootproto dhcp --hostname=$guesthost
keyboard uk
rootpw  --iscrypted $cryptpw
firewall --disabled
authconfig --enableshadow --passalgo=sha512 --enablefingerprint
selinux --disable

sshpw --username=root xenroot --plaintext
sshpw --username=iwj xenroot --plaintext

timezone --utc Europe/London
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb console=ttyS0,$c{Baud}n8"

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work

clearpart --all --initlabel
#--drives=sda
#ignoredisk --only-use=sda

#pv.lOpv5Y-s8zb-V13U-mGJ0-poLa-by7u-4stCVC
#physvol

part /boot --fstype=ext4 --size=500
part pv.physvol --grow --size=1
volgroup vg_$guesthost --pesize=4096 pv.physvol
logvol / --fstype=ext4 --name=lv_root --vgname=vg_$guesthost --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=vg_$guesthost --grow --size=1008 --maxsize=2016

#repo --name="Red Hat Enterprise Linux"  --baseurl=file:///mnt/source --cost=100

reboot

\%packages
\@base
\@core
\@perl-runtime
pax
rpmdevtools
rpmlint
\%end

\%post
(
  set -e
  umask 022
  mkdir /root/.ssh
  cd /root/.ssh
  cat <<'ENDKEYS' >authorized_keys
$authkeys
ENDKEYS
)
END
}

our $emptyiso= '/root/$flight.$job.$gn-empty.iso';

sub prep () {
    target_install_packages_norec($ho, qw(lvm2 rsync xorriso));

    my $isotimeout= 600;

    $gho= prepareguest($ho, $gn, $guesthost, 22,
                       $disk_mb + 1,
                       100);

    my $newiso= '/root/$flight.$job.$gn-newiso';
    my $emptydir= '/root/$flight.$job.$gn-empty-dir';

    iso_create_empty($ho, $emptyiso, $emptydir);

    my @isogen= iso_gen_flags_basic();

    more_prepareguest_hvm($ho,$gho, $ram_mb, $disk_mb,
                          OnReboot => 'preserve',
                          PostImageHook => sub {
        target_cmd_root($ho, iso_copy_content_from_image($gho,$newiso), $isotimeout);
        target_editfile_root($ho, "$newiso/isolinux/isolinux.cfg", sub {
            while (<EI>) {
                if (m/^\s+append/) {
                    s,$, sshd ks=cdrom:/ks.cfg,;
                    s/\baskmethod\b\S*/ /;
                    s#$# console=ttyS0,$c{Baud}n8#;
                }
                s/^timeout.*/timeout 10/;
                print EO or die $!;
            }
        });

        target_putfilecontents_root_stash($ho, 10, kickstart(),
                                          "$newiso/ks.cfg");

        iso_create_xorriso($ho, $gho->{Rimage}, $newiso, $isotimeout, @isogen);
    });
}

if (!$stage) {
    prep();
    guest_create($gho,$xl);
} else {
    $gho= selectguest($gn,$gho);
}
if ($stage<2) {
    guest_await_reboot($ho,$gho,2000);
    guest_destroy($ho,$gho);
}

guest_editconfig_nocd($gho,$emptyiso);
guest_create($gho,$xl);
guest_await_dhcp_tcp($gho,300);
guest_check_up($gho);
