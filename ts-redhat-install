#!/usr/bin/perl -w

use strict qw(vars);
use DBI;
use Osstest;

readconfig();
opendb_state();

our ($whhost,$gn) = @ARGV;
$whhost ||= 'host';
$gn ||= 'redhat';

our $ho= selecthost($r{$whhost});

our $ram_mb=    768;
our $disk_mb= 50000;

our $guesthost= "$gn.guest.osstest";
our $gho;

sub kickstart () {
    return <<'END';
# Kickstart file automatically generated by anaconda.
# edited by iwj

#version=RHEL6
install
cdrom
lang en_US.UTF-8
keyboard uk
rootpw  --iscrypted $6$anjRJmBbJcrNJGWN$rqvGUhu8ITjvErdIA5C//w2R6b/6wAjHbaF7XF8u3lZg1XI3StthPIE6UII08scOFwASMOepCGpgtsYeCpjqb.
firewall --service=ssh
authconfig --enableshadow --passalgo=sha512 --enablefingerprint
selinux --enforcing
timezone --utc Europe/London
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto rhgb quiet"

# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work

clearpart --all --initlabel
#--drives=sda
#ignoredisk --only-use=sda

part /boot --fstype=ext4 --size=500
part pv.lOpv5Y-s8zb-V13U-mGJ0-poLa-by7u-4stCVC --grow --size=1
volgroup vg_redhat --pesize=4096 pv.lOpv5Y-s8zb-V13U-mGJ0-poLa-by7u-4stCVC
logvol / --fstype=ext4 --name=lv_root --vgname=vg_redhat --grow --size=1024 --maxsize=51200
logvol swap --name=lv_swap --vgname=vg_redhat --grow --size=1008 --maxsize=2016

repo --name="Red Hat Enterprise Linux"  --baseurl=file:///mnt/source --cost=100

%packages
@additional-devel
@base
@core
@debugging
@basic-desktop
@desktop-debugging
@desktop-platform
@desktop-platform-devel
@development
@directory-client
@eclipse
@emacs
@fonts
@general-desktop
@graphical-admin-tools
@graphics
@input-methods
@internet-browser
@java-platform
@legacy-x
@network-file-system-client
@performance
@perl-runtime
@print-client
@remote-desktop-clients
@server-platform
@server-platform-devel
@tex
@technical-writing
@virtualization
@virtualization-client
@virtualization-platform
@x11
libXinerama-devel
xorg-x11-proto-devel
startup-notification-devel
libgnomeui-devel
libbonobo-devel
junit
libXau-devel
libgcrypt-devel
popt-devel
libdrm-devel
libXrandr-devel
libxslt-devel
libglade2-devel
gnutls-devel
mtools
pax
python-dmidecode
oddjob
sgpio
genisoimage
wodim
abrt-gui
desktop-file-utils
ant
rpmdevtools
jpackage-utils
rpmlint
certmonger
pam_krb5
krb5-workstation
nscd
pam_ldap
nss-pam-ldapd
netpbm-progs
libXmu
perl-DBD-SQLite
libvirt-java
%end
END
}

sub prep () {
    target_install_packages_norec($ho, qw(lvm2 rsync genisoimage));

    my $isotimeout= 300;

    $gho= prepareguest($ho, $gn, $guesthost, 22, $disk_mb + 1);

    my $newiso= '/root/newiso';

    more_prepareguest_hvm($ho,$gho, $ram_mb, $disk_mb, sub {
        target_cmd_root($ho, <<END, $isotimeout);
            set -x
            umount /mnt ||:
            rm -rf $newiso
            mount -o loop -r $gho->{Rimage} /mnt
            mkdir $newiso
            cp -a /mnt/. $newiso/.
            umount /mnt
END
        target_editfile_root($ho, "$newiso/isolinux/isolinux.cfg", sub {
            while (<EI>) {
                if (m/^\s+append/) {
                    s,$, ks=cdrom:/ks.cfg,;
                    s/\baskmethod\b\S*/ /;
                }
                s/^timeout.*/timeout 10/;
                print EO or die $!;
            }
        });

        target_putfilecontents_root_stash($ho, 10, kickstart(),
                                          "$newiso/ks.cfg");
        my @isogen_opts= qw(-R -J -T
                            -b isolinux/isolinux.bin -c isolinux/boot.cat
                            -no-emul-boot -boot-load-size 4 -boot-info-table);
        target_cmd_root($ho, <<END, $isotimeout);
            genisoimage -o $gho->{Rimage} @isogen_opts $newiso/.
END
    });
}

sub start () {
    target_cmd_root($ho, "xl create $gho->{CfgPath}", 100);
}

prep();
start();

guest_await_dhcp_tcp($gho,22);
guest_check_up($gho);
