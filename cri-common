# -*- bash -*-

umask 002

getconfig () {
        perl -e '
                use Osstest;
                readconfigonly();
                print $c{'$1'} or die $!;
        '
}

repo_tree_rev_fetch_git () {
	local treename=$1
	local remoteurl=$2
	local remotetag=$3
	local localtag=$4
	if ! test -d $repos/$treename; then
	        CACHEING_GIT_CACHE=$repos/git-cache ./cacheing-git \
			clone --bare $remoteurl $repos/$treename
	fi
	cd $repos/$treename
	git fetch -f $remoteurl $remotetag:$localtag
	git-rev-parse $localtag^0
}

select_xenbranch () {
	case "$branch" in
	xen*)			tree=xen;	xenbranch=$branch ;;
        qemu-upstream-*)    tree=qemuu; xenbranch=xen-${branch#qemu-upstream-};;
	linux)			tree=linux;	xenbranch=xen-unstable ;;
	linux-*)		tree=linux;	xenbranch=xen-unstable ;;
	osstest)		tree=osstest;	xenbranch=xen-unstable ;;
	esac
	if [ "x$tree" = xlinux ]; then
		linuxbranch=$branch
	else
		linuxbranch=linux
	fi
}

select_branch () {
	select_xenbranch

	check_stop $branch.
	check_stop $xenbranch.any.

	mrof="$branch.mro"

	if test -f branch-settings.$branch; then
		. branch-settings.$branch
	fi
}
