#!/bin/bash
set -ex

. cri-bisect
. cri-args-hostlists

branch=$1; shift
select_branch

check_stop bisect.

sticky=bisecting-sticky-branch

anyflagfile=tmp/bisected-any.$branch

with-lock-ex -w $mrof.lock bash -xec "
	if test -e $mrof.in; then
		if test -e $mrof; then mv $mrof $mrof.old; fi
                rm -f $anyflagfile
		mv $mrof.in $mrof
	fi
"

if ! test -f $mrof; then
        rm -f $sticky
        echo "$branch no mro"
        exit 0
fi

if grep '^tolerable$' $mrof >/dev/null 2>&1; then
	# this approach relies on us getting a look-in in between
	# each daily run, which should be OK.
	rm -f tmp/bisected.$branch.*
fi

if test -f $sticky; then
        read <$sticky sticky_branch
        if [ "x$sticky_branch" != "x$branch" ]; then
                echo "$branch but sticky $sticky_branch, skipping"
                exit 0
        fi
fi

compute_state_done_callback () {
        touch $flagfile
        touch $anyflagfile
        rm -f $sticky
}

compute_state_callback () {
	compute_state_core  --graph-out=$bisfile \
                --summary-out=$summaryfile \
                --blessings=$OSSTEST_BLESSING,$OSSTEST_BLESSING-bisect \
                "$@" $branch $job $testid >$reportfile 2>&1
}

perhaps_bisect_step_core_testing_callback () {
#        echo $branch >$sticky.new
#        mv -f $sticky.new $sticky
}

perhaps_bisect_step () {
        laundered_testid=${testid//\//--}
        flagfile=tmp/bisected.$branch.$job.$laundered_testid
        if test -f $flagfile; then
                echo "already completed $branch $job $testid"
                return
        fi
}

subject_prefix="[$branch bisection]"

exec <$mrof
while read keyword job testid basisflight; do
        if [ "x$keyword" = xregression ]; then
                perhaps_bisect_step
        fi
done

echo nothing to do
rm $mrof

exit 0
