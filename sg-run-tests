#!/usr/bin/tclsh8.4
# -*- Tcl -*- 
# usage: ./sg-run-tests <flight>

source osstestlib.tcl

readconfig

proc main {} {
    global flight jobinfo builds anyfailed argv

    set-flight
    become-task "$flight $argv"
    
    set tests {}
    set anyfailed 0

    db-open

    set to_run {}
    pg_execute -array jobinfo dbh "
        SELECT job, recipe FROM jobs
			WHERE	flight=$flight
			AND	job like 'test%'
			AND   ( status = 'queued'
			  OR	status = 'preparing'
			  OR	status = 'retriable' )
                        [specific-job-constraint]
		ORDER BY job
    " {
        lappend to_run [list $jobinfo(job) $jobinfo(recipe)]
    }

    db-close

    foreach jobitem $to_run {
        lassign $jobitem jobinfo(job) jobinfo(recipe)
        run-job
    }

    if {$anyfailed} {
        logputs stdout "at least one test failed"
    }
}

main
