#!/bin/sh
set -ex

dcs=daily-cron-settings

if [ "x$1" = "x--real" ]; then
	: ${OSSTEST_BLESSING:=real}
	shift
elif [ "x$1" = "x--like-real" ]; then
	: ${OSSTEST_CRON_SETTINGS:=$dcs-real}
	shift
fi	
: ${OSSTEST_BLESSING:=play}

if [ x"$OSSTEST_BLESSING" = xreal ]; then
	cd ${OSSTEST_DIR:=/export/home/osstest/testing.git}
fi

: ${OSSTEST_EMAIL_HEADER:=daily-cron-email-$OSSTEST_BLESSING}

. ${OSSTEST_CRON_SETTINGS:-$dcs-$OSSTEST_BLESSING}

: ${ARCH_RUNVARS_i386:="host=$OSSTEST_HOST_i386"}
: ${ARCH_RUNVARS_amd64:="host=$OSSTEST_HOST_amd64"}
export ARCH_RUNVARS_i386
export ARCH_RUNVARS_amd64

if [ "x$OSSTEST_HOST_i386" != x"$OSSTEST_HOST_amd64" ]; then
	hostlists1="$OSSTEST_HOST_i386 $OSSTEST_HOST_amd64"
else
	hostlists1="$OSSTEST_HOST_i386"
fi

export PAIR_RUNVARS="src_host=$OSSTEST_HOST_PAIR1 dst_host=$OSSTEST_HOST_PAIR2"
hostlists2=`perl -e 'print join ",", sort @ARGV' \
	$OSSTEST_PAIR_HOST1 $OSSTEST_PAIR_HOST2`

flight=`./make-flight "$@"`

./execute-flight $flight $OSSTEST_BLESSING \
        "$hostlists1" "$hostlists2" \
        >tmp/$flight.transcript 2>&1

exec >tmp/$flight.email
cat $OSSTEST_EMAIL_HEADER
printf 'Subject: '

./sg-report-flight $flight

echo '---'
cat tmp/$flight.transcript
rm tmp/$flight.transcript

exec >/dev/null

/usr/sbin/sendmail -odi -oee -oi -t <tmp/$flight.email

rm tmp/$flight.email
