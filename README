Introduction
============

OSStest is the Xen Project automated test infrastructure.

Terminology
===========

"flight":

    Each run of osstest is referred to as a "flight". Each flight is
    given a unique ID (a number or name).

"job":

    Each flight consists of one or more "jobs". These are a sequence
    of test steps run in order and correspond to a column in the test
    report grid. They have names like "build-amd64" or
    "test-amd64-amd64-pv". A job can depend on the output of another
    job in the flight -- e.g. most test-* jobs depend on one or more
    build-* jobs.

"step":

    Each job consists of multiple "steps" which is an individual test
    operation, such as "build the hypervisor", "install a guest",
    "start a guest", "migrate a guest", etc. A step corresponds to a
    cell in the results grid. A given step can be reused in multiple
    different jobs, e.g. the "xen build" step is used in several
    different build-* jobs. This reuse can be seen in the rows of the
    results grid.

"runvar":

    A runvar is a named textual variable associated with each job in a
    given flight. They serve as both the inputs and outputs to the
    job.

    For example a Xen build job may have input runvars "tree_xen" (the
    tree to clone) and "revision_xen" (the version to test). As output
    it sets "path_xendist" which is the path to the tarball of the
    resulting binary.

    As a further example a test job may have an input runvar
    "xenbuildjob" which specifies which build job produced the binary
    to be tested. The "xen install" step can then read this runvar in
    order to find the binary to install.

    Other runvars also exist covering things such as:

        * constraints on which machines in the test pool a job can be
          run on (e.g. the architecure, the need for a particular
          processor class, the presence of SR-IOV etc).

        * the parameters of the guest to test (e.g. distro, PV vs HVM
          etc).

Operation
=========

A flight is constructed by the "make-flight" script.

"make-flight" will allocate a new flight number, create a set of jobs
with input runvars depending on the configuration (e.g. branch/version
to test).

A flight is run by the "mg-execute-flight" script, which in turn calls
"sg-execute-flight". "sg-execute-flight" then spawns an instance of
"sg-run-job" for each job in the flight.

"sg-run-job" encodes various recipes (sequences of steps) which are
referenced by each job's configuration. It then runs each of these in
turn, taking into account the prerequisites etc, by calling the
relevant "ts-*" scripts.

When running in standalone mode it is possible to run any of these
steps by hand, ("mg-execute-flight", "sg-run-job", "ts-*") although
you will need to find the correct inputs (some of which are documented
below) and perhaps take care of prerequisites yourself (e.g. running
"./sg-run-job test-armhf-armhf-xl" means you must have done
"./sg-runjob build-armhf" and "build-armhf-pvops" first.

Results
=======

For flights run automatically by the infrastructure an email report is
produced. For most normal flights this is mailed to the xen-devel
mailing list. The report for flight 24438 can be seen at

    http://lists.xen.org/archives/html/xen-devel/2014-01/msg01614.html

The report will link to a set of complete logs. Since these are
regularly expired due to space constraints the logs for flight 24438
have been archived to

    http://xenbits.xen.org/docs/osstest-output-example/24438/

NB: to save space any files larger than 100K have been replaced with a
placeholder.

The results grid contains an overview of the flight's execution.

The results for each job are reached by clicking the header of the
column in the results grid which will lead to reports such as:

    http://xenbits.xen.org/docs/osstest-output-example/24438/test-amd64-amd64-xl/info.html
    http://xenbits.xen.org/docs/osstest-output-example/24438/build-amd64/info.html

The job report contains all of the logs and build outputs associated
with this job.

The logs for a step are reached by clicking the individual cells of
the results grid, or by clicking the list of steps on the job
report. In either case this will lead to a report such as

    http://xenbits.xen.org/docs/osstest-output-example/24438/test-amd64-amd64-xl/4.ts-xen-install.log

Additional details (e.g. serial logs, guest cfg files, etc) will be
available in the complete logs associated with the containing job.

The runvars are listed in the results page for the job as "Test
control variables". e.g. See the end of:

    http://xenbits.xen.org/docs/osstest-output-example/24438/test-amd64-amd64-xl/info.html

In order to find the binaries which went into a test job you should
consult the results page for that job and find the relevant build
job. e.g.

    http://www.chiark.greenend.org.uk/~xensrcts/logs/24438/test-amd64-amd64-xl/info.html

lists "xenbuildjob" as "build-amd64". Therefore the input binaries are
found at

    http://www.chiark.greenend.org.uk/~xensrcts/logs/24438/build-amd64/info.html

which is linked from the top of the relevant column in the overview
grid.

Script Naming Conventions
=========================

Most of the scripts follow a naming convention:

ap-*:   Adhoc push scripts

cr-*:   Cron scripts

cri-*:  Cron scripts (internal)

cs-*:   Control Scripts

mg-*:   Management scripts

ms-*:   Management Services

sg-*:   ?

ts-*:   Test Step scripts.

sa-*:	Standalone mode.


Jobs
====

The names of jobs follow some common patterns:

    build-$ARCH

        Build Xen for $ARCH

    build-$ARCH-xend

        Build Xen for $ARCH, with xend enabled

    build-$ARCH-pvops

        Build an upstream ("pvops") kernel for $ARCH

build-$ARCH-oldkern

        Build the old "linux-2.6.18-xen" tree for $ARCH

test-$XENARCH-$DOM0ARCH-<CASE>

        A test <CASE> running a $XENARCH hypervisor with a $DOM0ARCH
        dom0.

        Some tests also have a -$DOMUARCH suffix indicating the
        obvious thing.

NB: $ARCH (and $XENARCH etc) are Debian arch names, i386, amd64, armhf.

Standalone Mode
===============

To run osstest in standalone mode:

 - You need to install
     sqlite3
     tcl8.4 tclx8.4 libsqlite3-tcl
     libdbi-perl libdbd-sqlite3-perl
     pax rsync
     curl
     netcat
     chiark-utils-bin

 - Optional: ipmitool

 - Write a config file
    ~/.xen-osstest/config
   See below.

 - Select the "branch" and job to reproduce.  By default the system
   gives you the "branch" consisting of tests run for the xen-unstable
   push gate.  You need to select a job.  The list of available jobs
   is that shown in the publicly emailed test reports on xen-devel, eg
     http://lists.xen.org/archives/html/xen-devel/2014-01/msg01614.html

   If you don't want to repro one of those and don't know how to
   choose a job, choose one of
      test-amd64-{i386,amd64}-xl       32/64-bit dom0,domU; Debian guest

 - Run ./standalone-reset

   This will call "make-flight" for you to create a flight targetting
   xen-unstable (this can be adjusted by passing parameters to
   standalone-reset). By default the flight identifier is
   "standalone". standalone-reset will also make sure that certain
   bits of static data are available (e.g. Debian installer images)

 - Then you can run
      ./sg-run-job <job>
   to run that job on the default host.  NB in most cases this will
   wipe the test box!  Relevant environment variables here are:
      OSSTEST_HOST_REUSE    if set to 1, does not reinstall the host
      OSSTEST_HOST_HOST     override config file TestHost setting
                             (strictly, the final `_HOST' is the
			      uppercase of the host's `ident' in the job)

   However, as test-amd64-{i386,amd64}-xl and other tests depends on
   some runtime variables generated by build-* jobs, you can run
   build-* jobs before running actual test jobs. If you don't want to do
   so you need to insert those missing runvars into standalone.db with
   sqlite3.

 - Don't forget to set the machine to pxeboot in the BIOS.

 - Currently you need a serial console at 115200 8n1; see TODO.

 - If you have an existing test host and guest set up
   you can run
      OSSTEST_JOB=<job>  ./ts-debian-install host=bedbug
   or some such to install a Debian guest on it.

========================================

Format of config file ~/.xen-osstest/config (you may set OSSTEST_CONFIG to
point to a different file, or :-separates series of files):

Lines containing:
   Name value
or
   Name=  perl expression
or
   Name= <<'END'    or <<END
   blah blah
   END

To set a value to the empty string, say
   Name=''

#-comments and blank lines are ignored.

For an example see  ./standalone-config-example
Values later in the file, or in a later file, take precedence.

========================================

Important config settings for standalone mode:

DnsDomain
   DNS domain to suffix to many things.  No default.
   For example, test box hostnames will by default be qualified
   with this name.

NetNameservers
   Space-separated list of nameserver IPv4 addresses

DebianMirrorHost
   Domain name or address of the Debian mirror to use.
   Set DebianMirrorSubpath to the path inside the mirror if
   your mirror isn't at http://<DebianMirrorHost>/debian/

TestHost <hostname>
TestHost_<ident> <hostname>
   Specifies the test box to use.  Should be a bare hostname,
   not an fqdn.

HostProp_<testbox>_Ether
   MAC address of the box <testbox>.  Only needed if you want
   to use the osstest host and Xen installer.

HostProp_<testbox>_Build_Make_Flags
   Extra flags to pass to "make". e.g. "-j<SOMETHING>"

HostProp_<testbox>_LinuxSerialConsole
   Set to Linux's name for the serial console device on the
   platform. Defaults to ttyS0. If set to "NONE" then the system will
   use VGA console instead.

HostProp_<testbox>_XenSerialConsole
   Set to Xen's name for the serial console device on the
   platform. Defaults to com1.

HostProp_<testbox>_DTUARTPath
   If XenSerialConsole is "dtuart" then this specifies the path in the
   DTB to the device to use. Can also specify an alias defined in the
   platforms DTB.

HostProp_<testbox>_DIFrontend
   Configure the frontend used by Debian installer. Default in osstest
   is a very basic "text" interface but for standalone configurations,
   especially on VGA, "newt" might be preferred.

HostProp_<testbox>_RebootTimeExtra
   Increase the timeout for rebooting the testbox by the given value
   (e.g., 400). This could be useful for machines with loads of RAM,
   where Xen takes really long time to boot (typically because of
   the "Scrubbing free RAM" phase).

HostProp_<testbox>_TftpScope
   Defines the Tftp scope (i.e. subnet) where this host resides. See
   "TftpFoo_<scope> and TftpFoo" below.

HostFlags_<testbox>
   Defines a set of flags for the host. Flags is a list separated by
   whitespace, comma or semi-colon. A flag can be unset by prepending
   a !. Only used in standalone mode.

HostGroup_<testbox> <group>
   Defines a group of similar hosts of which <testbox> is a
   member. This can then be used with HostGroupProp and HostGroupFlags

HostGroupProps_<group>_<prop>
   Equivalent to writing HostProp_<testbox>_<prop> for every testbox
   which declares HostGroup_<testbox>_<group>. Allows setting a set of
   common properties for a group of similar machines. These settings
   take precedence over the database provided settings, but are
   themselves overridden by host-specific properties.

HostGroupFlags_<group>
   Equivalent to writing HostFlags_<testbox> for every testbox which
   declares HostGroup_<testbox>_<group>. Allows setting a set of
   common flags for a group of similar machines. These flags are
   merged with the host specific flags. Only used in standalone mode.

DebianPreseed
   Text to add to the debian-installer preseed file.  Optional
   but you will need to set some NTP servers here if your firewall
   doesn't permit NTP to Debian's pool.ntp.org servers.

========================================

Config settings relevant only to standalone mode

JobDBStandaloneFilename
   Database file to use to record the "jobs" and their run variables.
   Default: ./standalone.db (sqlite3)

CaptureLogs
   boolean, set to 1 to enable ts-logs-capture

TestHostDomain            defaults to DnsDomain

TestHost_<ident>      where eg <ident> = "host"
TestHost

HostProp_<property>
HostProp_<host>_<property>
HostFlags                flag,flag,flag,...
HostFlags_<host>         flag,!flag,!flag,flag...

HostProp_DhcpWatchMethod
   leases <format> <source>
      where <format> is dhcp3
            <source> is filename (with slash) or <host>:<port>

AuthorizedKeysFiles
     :-separated list of files to concatenate into authorized_keys
AuthorizedKeysAppend
     literal text to add
The keys in ~/.ssh/id_{rsa,dsa}.pub and ~/.ssh/authorized_keys
(if they exist) are copied anyway.

TestHostKeypairPath

HostProp_GenEtherPrefixBase 5e:36:0e:f5
# 	                               :00:01 guest number in job appended
#            in standalone jobdb, ^^^^^ xor'd with low 16 bits of your uid

========================================

General config settings

Stash
Images
Logs

DebianSuite
GuestDebianSuite   defaults to DebianSuite

DebianPreseed      added to existing preseed file

DebianNonfreeFirmware
  List of debs of non-free firmware to include in the massaged
  debian-installer.  You will need this if you want to use network
  card which requires non-free firmware.  The default is just
  "firmware-bnx2'.  If your host operating system doesn't have
  grep-dctrl (for example because it's not Debian) then you must set
  this to the empty string, by writing  DebianNonfreeFirmware=''

TftpFoo_<scope> and TftpFoo

    Describes various properties relating to Tftp in a given <scope>,
    where a <scope> is a given subnet, DHCP server etc. Valid
    properties are:

        Path          The path to the root of the directory which is exposed by
                      the tftpserver (e.g. /tftpboot).
        TmpDir        A directory under `Path' to use for temporary files.

        PxeDir        The path under `Path' to the PXE configuration directory
                      (e.g. pxelinux.cfg)
        PxeGroup      The Unix group which should own files under `PxeDir'.
        PxeTemplates  See TftpPxeTemplates

        DiBase        The path under `Path' to the root of the debian installer
                      images.

    For hosts in scope "default", TftpFoo_default (if set) takes
    precedence over TftpFoo.  TftpFoo is used when the setting Foo is
    not defined for the host's scope.

TftpPxeTemplates
    List (space-separated) of template filenames for writing
    The templates contain variable substitutions %var%
    The variables are the runvars plus
        ether         host/guest mac address
        etherhyp      ... in lowercase hyphen-separated form (for pxelinux)
	ipaddr        host/guest static ip address
	ipaddrhex     ... in uppercase hex form (for pxelinux)
    Templates containing references to unknown %var%s - particularly,
    the host mac address when not known, or the guest's dynamic
    ip address - are skipped.  The first template all of whose ingredients
    are known is used, with TftpPath and TftpPxeDir prepended.

========================================

Host-specific config settigs

NetNameServers

WebspaceFile
WebspaceUrl
WebspaceCommon
WebspaceLog

========================================

Some of the config settings relevant to the production setup
(`Executive') include:

JobDB
HostDB
   Class name tails for the job and host databases.

ExecutiveDbnamePat
   Pattern for generating PostgreSQL dbname strings for the executive's
   various databases.  Processed as follows:
     1. <\w+> is replaced with variables:
		 <dbname>    database name
     2. <~/path> </path> <./path> are replaced with contents of specified file 
     3. <[> and <]> are replaced with < and >

ExecutiveDbname_<DB>
   PostgreSQL dbname string for the database <DB>.  Default is to use
   ExecutiveDbnamePat.
